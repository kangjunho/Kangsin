<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>06. Variant Annotation (Funcotator / VEP / SnpEff)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <style>
    pre { position: relative; background:#f8f9fa; padding:1rem; border-radius:6px; }
    .copy-btn { position:absolute; top:6px; right:6px; font-size:.8rem; }
    code { white-space: pre; }
    .note { color:#444; }
    .tip-card { border-left:4px solid #0d6efd; background:#f8fbff; }
    .tip-title { font-weight:700; color:#0d6efd; }
    .mini { font-size:.95rem; color:#555; }
    .tbl-sm td, .tbl-sm th { padding:.45rem .6rem; }
  </style>
</head>
<body>
<div class="container py-5">
  <h1 class="mb-3">Step 06. Variant Annotation</h1>
  <p class="lead">
    변이(VCF)를 유전자/단백질 영향, 인구 빈도, 임상 DB 정보로 <b>주석(annotation)</b>합니다.
    이 가이드는 <b>Funcotator</b>(GATK) 중심이며, 대안으로 <b>VEP</b>, <b>SnpEff</b>도 간단히 소개합니다.
  </p>
  <hr/>

  <!-- A) 개요 -->
  <h3>A) 왜 주석이 필요한가?</h3>
  <ul>
    <li><b>생물학적 영향</b>: 유전자/전사체/아미노산 변화(예: p.G12D), 예측 영향.</li>
    <li><b>인구 빈도</b>: gnomAD/1KGP 등(희귀/공통 구분).</li>
    <li><b>임상 지식</b>: ClinVar, COSMIC 등.</li>
    <li><b>다운스트림</b>: 필터링·우선순위·리포팅(예: MAF 생성 후 maftools/OncoPrint 등).</li>
  </ul>

  <!-- B) 공통 변수 -->
  <h3 class="mt-4">B) 공통 변수 & 경로</h3>
  <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 스레드 & 레퍼런스
THREADS=20
REF_DIR="/home/kang/raw_data/gatk_bundle/v0"
REF="${REF_DIR}/Homo_sapiens_assembly38.fasta"

# 입력(05단계 출력)
VAR_IN="/home/kang/God_Nas/WGS_2nd/variant"     # *.filtered.vcf.gz

# 출력
ANN_OUT="/home/kang/God_Nas/WGS_2nd/annotation"
mkdir -p "${ANN_OUT}"

# Funcotator 데이터소스(로컬 위치로 수정)
FUNC_DS="/home/kang/raw_data/gatk_bundle/dataSourcesFolder/funcotator_dataSources.v1.7.20200521s/"
</code></pre>

  <!-- C) 사전 정리: 정규화 -->
  <h3 class="mt-4">C) 주석 전 정규화(권장)</h3>
  <p class="note">인델의 <b>left-align</b> 및 <b>multi-allelic 분리</b>는 주석 정확도를 높입니다.</p>
  <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 예: NP-21.filtered.vcf.gz → 정규화
SAMPLE="NP-21"
bcftools norm -f "${REF}" -m -both \
  -O z -o "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz" \
  "${VAR_IN}/${SAMPLE}.filtered.vcf.gz"
tabix -p vcf "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz"
</code></pre>

  <!-- D) Funcotator -->
  <h3 class="mt-4">D) Funcotator (권장)</h3>
  <div class="card tip-card mb-3">
    <div class="card-body">
      <div class="tip-title mb-2">데이터소스 & 전사체 주의</div>
      <ul class="mb-0">
        <li><b>데이터소스</b>는 레퍼런스 빌드(hg38)와 일치해야 함.</li>
        <li><b>전사체</b>: 기본은 Gencode. 프로젝트에서 보고 전사체 기준을 명시적으로 고정.</li>
        <li>출력: <b>Somatic → MAF</b>가 리포팅/시각화에 편리, <b>Germline → VCF</b> 주로 사용.</li>
      </ul>
    </div>
  </div>

  <h5>D-1) Somatic(종양) 결과를 MAF로</h5>
  <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
SAMPLE="NP-21"

gatk Funcotator \
  -R "${REF}" \
  -V "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz" \
  -O "${ANN_OUT}/${SAMPLE}.funcotated.maf.gz" \
  --output-file-format MAF \
  --data-sources-path "${FUNC_DS}" \
  --ref-version hg38 \
  --annotation-default tumor_barcode:${SAMPLE}
</code></pre>

  <h5 class="mt-3">D-2) Germline VCF을 주석(VCF 유지)</h5>
  <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
SAMPLE="Family01_Proband"

gatk Funcotator \
  -R "${REF}" \
  -V "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz" \
  -O "${ANN_OUT}/${SAMPLE}.funcotated.vcf.gz" \
  --output-file-format VCF \
  --data-sources-path "${FUNC_DS}" \
  --ref-version hg38
tabix -p vcf "${ANN_OUT}/${SAMPLE}.funcotated.vcf.gz"
</code></pre>

  <!-- E) 배치 스크립트 -->
  <h3 class="mt-4">E) 배치 실행 스크립트 (Somatic → MAF)</h3>
  <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
#!/usr/bin/env bash
set -euo pipefail
THREADS=20
REF="/home/kang/raw_data/gatk_bundle/v0/Homo_sapiens_assembly38.fasta"
VAR_IN="/home/kang/God_Nas/WGS_2nd/variant"
ANN_OUT="/home/kang/God_Nas/WGS_2nd/annotation"
FUNC_DS="/home/kang/raw_data/gatk_bundle/dataSourcesFolder/funcotator_dataSources.v1.7.20200521s/"
mkdir -p "${ANN_OUT}"

shopt -s nullglob
for VCF in "${VAR_IN}"/*.filtered.vcf.gz; do
  SAMPLE="$(basename "${VCF}" .filtered.vcf.gz)"
  echo "[NORM] ${SAMPLE}"
  bcftools norm -f "${REF}" -m -both -O z -o "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz" "${VCF}"
  tabix -p vcf "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz"

  echo "[FUNCOTATOR] ${SAMPLE}"
  gatk Funcotator -R "${REF}" \
    -V "${ANN_OUT}/${SAMPLE}.normalized.vcf.gz" \
    -O "${ANN_OUT}/${SAMPLE}.funcotated.maf.gz" \
    --output-file-format MAF \
    --data-sources-path "${FUNC_DS}" \
    --ref-version hg38 \
    --annotation-default tumor_barcode:${SAMPLE}
done
echo "All annotations written to: ${ANN_OUT}"
</code></pre>

  <!-- F) 주요 컬럼(예: MAF) -->
  <h3 class="mt-4">F) MAF 주요 컬럼 한눈에</h3>
  <div class="table-responsive">
    <table class="table table-bordered tbl-sm align-middle">
      <thead class="table-light">
        <tr><th>컬럼</th><th>설명</th></tr>
      </thead>
      <tbody>
        <tr><td><b>Hugo_Symbol</b></td><td>유전자명</td></tr>
        <tr><td><b>Chromosome / Start_Position / End_Position</b></td><td>게놈 위치</td></tr>
        <tr><td><b>Variant_Classification / Variant_Type</b></td><td>예: Missense_Mutation / SNP, INS, DEL</td></tr>
        <tr><td><b>Reference_Allele, Tumor_Seq_Allele1/2</b></td><td>염기 정보</td></tr>
        <tr><td><b>t_depth, t_ref_count, t_alt_count</b></td><td>종양 depth 및 ref/alt 카운트</td></tr>
        <tr><td><b>tumor_barcode</b></td><td>샘플명(우리가 기본 주입)</td></tr>
        <tr><td><b>gnomAD_xxx</b></td><td>인구 빈도(희귀 변이 판별에 중요)</td></tr>
        <tr><td><b>ClinVar_*</b></td><td>임상 해석(해석 시 버전/맥락 확인)</td></tr>
        <tr><td><b>HGVSp/HGVSc</b></td><td>단백질/전사체 표기(p./c.)</td></tr>
      </tbody>
    </table>
  </div>

  <!-- G) 대안 툴 -->
  <h3 class="mt-4">G) 대안: VEP / SnpEff (요약)</h3>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Ensembl VEP</h5>
          <p class="note">플러그인으로 gnomAD/ClinVar/CADD 등 확장 쉬움. 로컬 캐시 설치 필요.</p>
          <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 예시: VEP VCF → VCF
vep -i input.vcf.gz -o output.vep.vcf.gz --vcf \
  --cache --offline --assembly GRCh38 \
  --dir_cache /path/to/vep_cache \
  --fork 20 --compress_output bgzip
tabix -p vcf output.vep.vcf.gz
</code></pre>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">SnpEff</h5>
          <p class="note">가볍고 빠름. snpSift로 추가 필터/주석 가능.</p>
          <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 예시: SnpEff
snpEff -v GRCh38.99 input.vcf.gz | bgzip -c > output.snpeff.vcf.gz
tabix -p vcf output.snpeff.vcf.gz
</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- H) 자주 하는 실수 & 팁 -->
  <h3 class="mt-4">H) 자주 하는 실수 & 팁</h3>
  <ul class="note">
    <li><b>빌드/전사체 불일치</b>: hg19 vs hg38, RefSeq vs Gencode 혼용 금지.</li>
    <li><b>정규화 생략</b>: 인델 left-align, multi-allelic 분리를 먼저 수행.</li>
    <li><b>복수 전사체</b>: 보고 기준(대표 전사체)을 프로젝트 차원에서 고정.</li>
    <li><b>임상 DB 최신성</b>: ClinVar/COSMIC 등은 버전 의존. 리포트 시 버전 명기.</li>
  </ul>

  <!-- I) 요약 카드 (마무리) -->
  <section class="mt-4">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white fw-bold">요약 & 튜토리얼 마무리</div>
      <div class="card-body">
        <ul class="mb-3">
          <li>주석 전 <b>bcftools norm</b>으로 <b>left-align + multiallelic 분리</b> 권장.</li>
          <li><b>Funcotator</b>로 <b>Somatic→MAF</b>, <b>Germline→VCF</b> 주석(데이터소스/빌드 일치 필수).</li>
          <li>핵심 컬럼: <b>유전자/좌표/분류/카운트/빈도/임상</b>. 이후 우선순위·리포팅에 활용.</li>
          <li>대안: <b>VEP/SnpEff</b>도 가능(캐시/DB 준비 필요).</li>
        </ul>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-outline-secondary" href="05_variant_calling.html">← Back: Variant Calling</a>
          <a class="btn btn-primary" href="index.html">WGS Tutorial Home</a>
          <a class="btn btn-link" href="../e-learning.html">E-learning</a>
          <a class="btn btn-link" href="../index.html">Site Home</a>
          <a class="btn btn-link" href="https://gatk.broadinstitute.org/hc/en-us/articles/360035894731-Funcotator" target="_blank" rel="noopener">Funcotator Docs ↗</a>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  function copyCode(btn){
    const code = btn.nextElementSibling.innerText;
    navigator.clipboard.writeText(code).then(()=>{
      const old = btn.innerText; btn.innerText = "Copied!";
      setTimeout(()=>{ btn.innerText = old; }, 1800);
    });
  }
</script>
</body>
</html>
