<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>02. Adapter Trimming (Cutadapt)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <style>
    pre { position: relative; background: #f8f9fa; padding: 1rem; border-radius: 6px; }
    .copy-btn { position: absolute; top: 6px; right: 6px; font-size: 0.8rem; }
    code { white-space: pre; }
    .note { font-size: .95rem; color:#444; }
    .qc-img { width:100%; border:1px solid #e5e7eb; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-3">Step 02. Adapter Trimming (Cutadapt)</h1>
    <p class="lead">
      페어드엔드 FASTQ(<code>R1</code>/<code>R2</code>)에서 Illumina 어댑터 서열을 제거합니다. 기본 쓰레드는 <b>20</b>을 사용합니다.
      자세한 사용법은 공식 문서(<a href="https://cutadapt.readthedocs.io/en/stable/" target="_blank" rel="noopener">Cutadapt User Guide</a>)를 참고하세요.
    </p>
    <hr/>

    <h3>0) 시작하기 전에</h3>
    <p class="note">Conda 환경을 활성화하면 터미널 프롬프트 앞에 보통 <code>(wgs_env)</code>처럼 환경명이 표시됩니다.</p>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# Conda 환경 활성화
conda activate wgs_env

# 프롬프트 예시 (환경명이 괄호로 표시됨)
# (wgs_env) kang@host:~/path/to/fastq$
</code></pre>

    <h3 class="mt-4">1) 입력 데이터 & 어댑터 서열</h3>
    <ul>
      <li><b>페어드엔드(PE)</b> 샘플은 파일이 2개로 구성됩니다:
        <code>SAMPLE_R1.fastq.gz</code> (Forward/Read1), <code>SAMPLE_R2.fastq.gz</code> (Reverse/Read2)</li>
      <li>일반적인 Illumina TruSeq 어댑터:
        <ul>
          <li>R1 어댑터(Forward): <code>AGATCGGAAGAGCACACGTCTGAACTCCAGTCA</code></li>
          <li>R2 어댑터(Reverse): <code>AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT</code></li>
        </ul>
      </li>
    </ul>

    <p class="note">원한다면 압축 FASTQ에서 어댑터 서열이 보이는지 간단히 확인할 수 있습니다(빠른 스폿 체크).</p>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# R1에서 Forward 어댑터 검색 (gzip 압축 파일에는 zgrep 권장)
zgrep -a 'AGATCGGAAGAGCACACGTCTGAACTCCAGTCA' sample1_1.fastq.gz | head

# R2에서 Reverse 어댑터 검색
zgrep -a 'AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT' sample1_2.fastq.gz | head

# 대화형으로 보고 싶다면:
# zless sample1_1.fastq.gz   # 연 후에 /AGATCGG... 로 검색
</code></pre>

    <h3 class="mt-4">2) 변수 설정</h3>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 공통 변수
THREADS=20
OUTDIR="/home/kang/God_Nas/WGS_2nd/Trimmed_fastq"
mkdir -p "${OUTDIR}"

# 어댑터 서열
ADAPTER_FWD="AGATCGGAAGAGCACACGTCTGAACTCCAGTCA"
ADAPTER_REV="AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT"
</code></pre>

    <h3 class="mt-4">3) 배치 실행 스크립트 (<code>run_cutadapt.sh</code>)</h3>
    <p class="note">현재 폴더의 <code>*_R1.fastq.gz</code>를 기준으로 페어(R2)를 찾아 일괄 처리합니다.</p>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
#!/usr/bin/env bash
set -euo pipefail

THREADS=20
OUTDIR="/home/kang/God_Nas/WGS_2nd/Trimmed_fastq"
mkdir -p "${OUTDIR}"

ADAPTER_FWD="AGATCGGAAGAGCACACGTCTGAACTCCAGTCA"
ADAPTER_REV="AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT"

shopt -s nullglob
for R1 in *_R1.fastq.gz; do
  SAMPLE="$(basename "${R1}" _R1.fastq.gz)"
  R2="${SAMPLE}_R2.fastq.gz"

  if [[ ! -f "${R2}" ]]; then
    echo "[WARN] ${SAMPLE}: paired R2 not found. Skip." >&2
    continue
  fi

  echo "[Cutadapt] ${SAMPLE}"
  cutadapt -j "${THREADS}" \
    -a "${ADAPTER_FWD}" \
    -A "${ADAPTER_REV}" \
    -o "${OUTDIR}/${SAMPLE}_R1.trimmed.fastq.gz" \
    -p "${OUTDIR}/${SAMPLE}_R2.trimmed.fastq.gz" \
    "${R1}" "${R2}"
done

echo "All trimming jobs finished. Output: ${OUTDIR}"
</code></pre>

    <h3 class="mt-4">4) 실행</h3>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 트리밍할 FASTQ들이 있는 폴더로 이동
cd /path/to/fastq_folder

# (wgs_env) 프롬프트 확인 후 실행
chmod +x run_cutadapt.sh
bash run_cutadapt.sh
</code></pre>

    <h3 class="mt-4">5) 출력물</h3>
    <ul>
      <li><code>${OUTDIR}/SAMPLE_R1.trimmed.fastq.gz</code></li>
      <li><code>${OUTDIR}/SAMPLE_R2.trimmed.fastq.gz</code></li>
    </ul>

    <h3 class="mt-4">6) (옵션) 로그 저장 & 품질/길이 필터</h3>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# 로그 저장 예시: 각 샘플의 실행 리포트를 파일로 남김
cutadapt -j "${THREADS}" \
  -a "${ADAPTER_FWD}" -A "${ADAPTER_REV}" \
  -o "${OUTDIR}/${SAMPLE}_R1.trimmed.fastq.gz" \
  -p "${OUTDIR}/${SAMPLE}_R2.trimmed.fastq.gz" \
  "${R1}" "${R2}" > "${OUTDIR}/${SAMPLE}.cutadapt.log" 2>&1

# (선택) 추가 옵션 예시
# -q 20 : Q20 미만의 말단 염기 트리밍
# -m 30 : 길이 30bp 미만 리드는 버림
# 예) cutadapt ... -q 20 -m 30 ...
</code></pre>

    <h3 class="mt-4">7) 품질 확인 (FastQC 전/후 비교)</h3>
    <p>
      트리밍 전/후로 <b>FastQC</b>를 실행해 품질 변화를 확인합니다.
      여러 샘플의 리포트를 한 번에 모아보려면 <b>MultiQC</b>를 사용합니다.
      FastQC 문서: <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/" target="_blank" rel="noopener">FastQC Home</a>
    </p>

    <h5 class="mt-3">실행 명령</h5>
    <pre><button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyCode(this)">Copy</button><code>
# (전) 원본 FASTQ
mkdir -p qc_raw
fastqc -t 20 *.fastq.gz -o qc_raw

# (후) 트리밍 FASTQ
mkdir -p qc_trimmed
fastqc -t 20 "${OUTDIR}"/*trimmed.fastq.gz -o qc_trimmed

# (요약) MultiQC로 한 페이지에 모으기
mkdir -p qc_multiqc
multiqc qc_raw qc_trimmed -o qc_multiqc
</code></pre>

    <h5 class="mt-3">Per base sequence quality (전/후 비교)</h5>
    <p class="note">
      그래프의 <b>y축은 Phred 품질 점수(Q)</b>이며, <code>Q = -10·log10(p)</code> (p: 오류확률)입니다.
      <b>Q20</b>≈1% 오류(99% 정확), <b>Q30</b>≈0.1% 오류(99.9% 정확)로 일반적으로 Q30 이상이면 양호합니다.
      배경색은 FastQC 권고: <span class="text-success">초록</span>(좋음) / <span class="text-warning">노랑</span>(보통) / <span class="text-danger">빨강</span>(나쁨).
    </p>

    <!-- 전/후 이미지를 좌우로 -->
    <div class="row g-3 align-items-start mb-3">
      <div class="col-md-6">
        <h6 class="text-center">Before trimming</h6>
        <img src="../assets/images/fastqc_before.png" class="qc-img" alt="FastQC before trimming (Per base quality)">
      </div>
      <div class="col-md-6">
        <h6 class="text-center">After trimming</h6>
        <img src="../assets/images/fastqc_after.png" class="qc-img" alt="FastQC after trimming (Per base quality)">
      </div>
    </div>

    <h5 class="mt-3">Adapter Content 확인 (전/후 비교)</h5>
    <p class="note">
      FastQC의 <b>Adapter Content</b> 모듈에서 위치별 어댑터 잔존 비율을 확인할 수 있습니다.
      일반적으로 <b>트리밍 전</b>엔 특정 위치 이후 어댑터 비율이 상승하고, <b>트리밍 후</b>엔 0에 가깝게 떨어지는 것이 이상적입니다.
    </p>
    <div class="row g-3 align-items-start mb-4">
      <div class="col-md-6">
        <h6 class="text-center">Before trimming</h6>
        <img src="../assets/images/adapter_content_before.png" class="qc-img" alt="Adapter content before trimming">
      </div>
      <div class="col-md-6">
        <h6 class="text-center">After trimming</h6>
        <img src="../assets/images/adapter_content_after.jpg" class="qc-img" alt="Adapter content after trimming">
      </div>
    </div>

    <div class="alert alert-info">
      <b>요약:</b> 과거에는 read 말단 품질 저하나 타일/기계 이슈가 흔했지만,
      최근에는 시퀀싱 장비·시약·라이브러리 준비 절차가 개선되어 <b>품질 이슈가 크게 줄었습니다</b>.
      따라서 보통은 <b>어댑터 서열만 정확히 제거</b>해도 후속 분석(BWA 정렬, GATK 변이 호출)에 무리가 없습니다.
      필요 시에만 추가적인 품질 트리밍(<code>-q</code>)이나 길이 필터(<code>-m</code>)를 적용하세요.
    </div>

    <div class="mt-4">
      <a class="btn btn-outline-secondary" href="index.html">← Back to WGS Tutorial</a>
      <a class="btn btn-primary" href="03_alignment.html">Next: Alignment →</a>
      <a class="btn btn-link" href="https://cutadapt.readthedocs.io/en/stable/" target="_blank" rel="noopener">Cutadapt User Guide ↗</a>
      <a class="btn btn-link" href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/" target="_blank" rel="noopener">FastQC ↗</a>
    </div>
  </div>

  <script>
    function copyCode(btn){
      const code = btn.nextElementSibling.innerText;
      navigator.clipboard.writeText(code).then(()=>{
        const old = btn.innerText; btn.innerText = "Copied!";
        setTimeout(()=>{ btn.innerText = old; }, 1800);
      });
    }
  </script>
</body>
</html>
